"""
初始化知识库脚本
添加示例育儿知识到RAG系统
"""
import sys
sys.path.append('../app')

import sys
import os

# 添加项目根目录到 pythonpath
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from app.rag_engine import RAGEngine


def init_knowledge_base():
    """初始化知识库"""
    print("正在初始化知识库...")

    # 创建RAG引擎
    engine = RAGEngine()

    # 示例知识库文档
    documents = [
        # 发烧相关
        {
            "id": "fever_001",
            "text": """婴儿发烧的处理指南：

1. 体温测量：使用电子体温计测量腋温，正常体温为36-37度。
2. 何时用药：当体温超过38.5度时，可以考虑使用退烧药。
3. 常用退烧药：
   - 对乙酰氨基酚（泰诺林）：适用于3个月以上婴儿
   - 布洛芬（美林）：适用于6个月以上婴儿
4. 物理降温：温水擦浴、减少衣物、保持室内通风
5. 何时就医：
   - 3个月以下婴儿发烧必须立即就医
   - 体温超过40度
   - 发烧伴随精神萎靡、抽搐、呼吸困难
   - 发烧持续超过3天

来源：美国儿科学会（AAP）育儿百科""",
            "metadata": {"category": "发烧", "source": "AAP", "age_range": "0-3岁"}
        },
        {
            "id": "fever_002",
            "text": """退烧药使用注意事项：

1. 美林（布洛芬）和泰诺林（对乙酰氨基酚）的区别：
   - 美林：退烧效果更强，持续时间更长（6-8小时），但6个月以下不能用
   - �诺林：相对温和，3个月以上即可使用，持续时间4-6小时

2. 能否同时使用：
   - 不建议同时使用两种退烧药
   - 如果一种药物效果不佳，可以在4-6小时后交替使用
   - 必须严格记录用药时间，避免过量

3. 剂量：
   - 必须根据宝宝体重计算，严格遵照说明书或医嘱
   - 不要自行增加剂量

来源：中国儿科用药指南""",
            "metadata": {"category": "用药", "source": "中国儿科指南"}
        },

        # 便秘相关
        {
            "id": "constipation_001",
            "text": """婴儿便秘的处理方法：

1. 判断标准：
   - 大便干硬、排便困难
   - 排便频率明显减少（因人而异）
   - 排便时哭闹、肛门出血

2. 家庭护理：
   - 增加水分摄入（已添加辅食的宝宝）
   - 腹部按摩：顺时针轻柔按摩腹部
   - 适当运动：帮助宝宝做蹬腿运动

3. 饮食调整：
   - 西梅泥：天然通便，效果好
   - 梨泥、苹果泥：富含纤维
   - 避免过多米粉、香蕉（可能加重便秘）

4. 何时就医：
   - 便秘持续超过1周
   - 伴随呕吐、腹痛
   - 肛门出血严重

来源：美国儿科学会育儿百科""",
            "metadata": {"category": "便秘", "source": "AAP"}
        },

        # 湿疹相关
        {
            "id": "eczema_001",
            "text": """婴儿湿疹的护理指南：

1. 什么是湿疹：
   - 婴儿常见的皮肤问题，表现为红色丘疹、皮肤干燥、瘙痒
   - 常见部位：面部、头皮、四肢

2. 家庭护理：
   - 保湿是关键：每天2-3次涂抹无香料的保湿霜
   - 避免过度清洁：每天洗澡1次，使用温和无刺激的沐浴露
   - 穿着：选择纯棉衣物，避免羊毛等刺激性材质
   - 室内环境：保持适宜温度和湿度

3. 何时就医：
   - 湿疹面积大、瘙痒严重
   - 出现渗液、结痂
   - 护理无效，影响睡眠

4. 注意事项：
   - 不要自行使用激素药膏
   - 避免搔抓，防止感染

来源：中国儿科皮肤病诊疗指南""",
            "metadata": {"category": "皮肤", "source": "中国儿科指南"}
        },

        # 头部外伤
        {
            "id": "head_injury_001",
            "text": """婴儿头部外伤的处理：

1. 立即观察：
   - 意识状态：是否清醒、反应是否正常
   - 哭声：短暂哭泣后停止是正常的
   - 外伤情况：是否有明显伤口、肿包

2. 危险信号（立即就医）：
   - 呕吐（尤其是反复呕吐）
   - 嗜睡、难以唤醒
   - 抽搐
   - 瞳孔大小不一
   - 持续哭闹超过30分钟
   - 从高处跌落（超过1米）

3. 家庭观察（轻微碰撞）：
   - 冷敷：用冰袋或冷毛巾敷在肿包处
   - 观察24小时：注意精神状态、饮食、睡眠
   - 避免剧烈活动

4. 何时可以放心：
   - 短暂哭泣后恢复正常
   - 精神状态良好
   - 饮食、睡眠正常
   - 无呕吐、抽搐等症状

来源：美国儿科学会急诊指南""",
            "metadata": {"category": "外伤", "source": "AAP"}
        },

        # 辅食添加
        {
            "id": "complementary_food_001",
            "text": """婴儿辅食添加指南：

1. 何时开始：
   - 6个月左右开始添加辅食
   - 信号：能坐稳、对食物感兴趣、挺舌反射消失

2. 第一口辅食：
   - 推荐：强化铁的婴儿米粉
   - 冲调：用母乳或配方奶冲调，稀糊状
   - 时间：选择宝宝精神好的时候，通常是上午

3. 添加顺序：
   - 第1-2周：米粉
   - 第3-4周：蔬菜泥（南瓜、胡萝卜）
   - 第5-6周：水果泥（苹果、香蕉）
   - 第7-8周：肉泥（鸡肉、猪肉）

4. 注意事项：
   - 每次只添加一种新食物，观察3-5天
   - 从少量开始，逐渐增加
   - 1岁前不加盐、糖、蜂蜜
   - 避免易过敏食物（花生、海鲜等）

来源：中国0-6岁儿童营养发展报告""",
            "metadata": {"category": "喂养", "source": "中国营养学会"}
        }
    ]

    # 添加文档到知识库
    engine.add_documents(documents)

    print(f"✅ 成功添加 {len(documents)} 条知识到知识库")

    # 测试检索
    print("\n测试检索功能...")
    test_query = "宝宝发烧了怎么办"
    results = engine.search(test_query, top_k=2)

    print(f"\n查询: {test_query}")
    print(f"检索到 {len(results)} 条相关知识：")
    for i, doc in enumerate(results, 1):
        print(f"\n{i}. {doc['text'][:100]}...")


if __name__ == "__main__":
    init_knowledge_base()
