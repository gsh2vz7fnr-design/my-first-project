# 诊断信息提取准确性测试报告

## 测试概要

**测试执行时间**: 2026-02-12
**测试文件**: `tests/test_extraction_accuracy.py`
**总测试数**: 22
**通过**: 14 (63.6%)
**失败**: 8 (36.4%)

## 测试场景覆盖

### 场景1: 单一症状描述 (4测试)
| 测试用例 | 状态 | 说明 |
|---------|------|------|
| TC-EXT-001: 发烧38度两天 | PASS | 正确提取症状、体温、持续时间 |
| TC-EXT-002: 一直咳嗽 | PASS | 正确识别咳嗽症状 |
| TC-EXT-003: 吐了两次 | FAIL | 呕吐被识别为accompanying_symptoms而非主症状 |
| TC-EXT-004: 拉肚子一天5次 | FAIL | 频率信息未正确提取 |

### 场景2: 多症状描述 (4测试)
| 测试用例 | 状态 | 说明 |
|---------|------|------|
| TC-EXT-005: 发烧咳嗽流鼻涕 | PASS | 正确识别主症状和伴随症状 |
| TC-EXT-006: 发烧39度有红点 | PASS | 正确提取体温和皮疹信息 |
| TC-EXT-007: 又吐又拉 | FAIL | 未识别主症状 |
| TC-EXT-008: 发烧伴多症状 | PASS | 正确提取多个伴随症状 |

### 场景3: 复杂病史 (4测试)
| 测试用例 | 状态 | 说明 |
|---------|------|------|
| TC-EXT-009: 哮喘病史喘息 | FAIL | 未提取任何医疗实体 |
| TC-EXT-010: 鸡蛋过敏起疹子 | PASS | 正确识别皮疹症状 |
| TC-EXT-011: 早产儿发烧 | PASS | 正确提取症状和体温 |
| TC-EXT-012: 先心病感冒 | PASS | 正确识别为医疗咨询 |

### 场景4: 跨轮次累积 (4测试)
| 测试用例 | 状态 | 说明 |
|---------|------|------|
| TC-EXT-013: 发烧->38.5度咳嗽 | FAIL | 症状被错误覆盖 |
| TC-EXT-014: 发烧->精神不好 | PASS | 正确累积精神状态 |
| TC-EXT-015: slot_filling意图 | PASS | 正确提取体温信息 |
| TC-EXT-016: 完整多轮场景 | FAIL | 持续时间提取失败 |

### 边界条件测试 (6测试)
| 测试用例 | 状态 | 说明 |
|---------|------|------|
| TC-EXT-017: 中文数字 | PASS | 正确识别症状 |
| TC-EXT-018: 体温格式 | FAIL | "38度5"未解析为38.5 |
| TC-EXT-019: 持续时间格式 | FAIL | "从昨天开始"未提取 |
| TC-EXT-020: 月龄格式 | PASS | 正确提取月龄 |
| TC-EXT-021: 精神状态 | PASS | 正确提取精神状态 |
| TC-EXT-ACC-001: 准确率评估 | PASS | 整体准确率达标 |

## 问题分析

### 问题1: 呕吐被识别为伴随症状而非主症状
**影响用例**: TC-EXT-003

**输入**: "宝宝吐了两次"
**预期**: symptom="呕吐"
**实际**: symptom=None, accompanying_symptoms="呕吐"

**原因**: 在`_postprocess_entities`方法中，呕吐被特殊处理，只有在不是主症状时才会加入伴随症状。当前逻辑中，"呕吐"可能没有正确设置为主症状。

**建议**: 修改`llm_service.py:644`的`_postprocess_entities`方法，当输入只包含呕吐相关词汇时，应将呕吐设为主症状。

### 问题2: 频率信息未正确提取
**影响用例**: TC-EXT-004

**输入**: "拉肚子，一天拉了5次"
**预期**: frequency包含"5"
**实际**: frequency为空

**原因**: 正则匹配模式`r"(每小时|每天|一天)\s*\d+次"`要求"一天/次"在前面，但用户说"一天拉了5次"格式不匹配。

**建议**: 扩展频率提取的正则模式，支持"一天X次"、"一天拉了X次"等多种格式。

### 问题3: "又吐又拉"未识别主症状
**影响用例**: TC-EXT-007

**输入**: "又吐又拉，吃什么都会吐出来"
**预期**: symptom为呕吐或腹泻
**实际**: symptom为空

**原因**: 当前symptom_map包含"呕吐"和"腹泻"，但"又吐又拉"这种口语表达模式未被识别。

**建议**: 增加口语化表达模式，如"又吐又拉"、"吐了拉了"等。

### 问题4: 哮喘病史喘息未提取医疗实体
**影响用例**: TC-EXT-009

**输入**: "有哮喘病史，现在出现喘息症状"
**预期**: 提取相关医疗信息
**实际**: 无任何医疗实体被提取

**原因**: 当前symptom_map中没有"喘息"、"哮喘"相关词条，且"病史"未被识别为医疗关键词。

**建议**: 扩展symptom_map，增加"喘息"、"哮喘"、"呼吸困难"等词条。

### 问题5: 跨轮次症状被错误覆盖
**影响用例**: TC-EXT-013

**场景**:
- 第一轮: "孩子发烧" -> symptom="发烧"
- 第二轮: "38.5度，伴有咳嗽" -> symptom被改为"咳嗽"

**预期**: symptom保持"发烧"
**实际**: symptom变为"咳嗽"

**原因**: 在`merge_entities`中，新值直接覆盖旧值。当第二轮只说"咳嗽"时，它覆盖了第一轮的"发烧"。

**建议**: 修改merge_entities逻辑，主症状应该有"粘性"，一旦设定不应被轻易覆盖，除非新输入更完整（包含更多上下文）。

### 问题6: "38度5"未解析为38.5
**影响用例**: TC-EXT-018

**输入**: "体温38度5"
**预期**: temperature="38.5度"
**实际**: temperature="38度"

**原因**: 当前正则`r"(\d+(?:\.\d+)?)\s*(?:度|℃|°c)"`只匹配小数点格式，不支持"38度5"这种中文口语表达。

**建议**: 增加正则模式`r"(\d+)度(\d+)"`来匹配"38度5"并转换为38.5。

### 问题7: "从昨天开始"未提取持续时间
**影响用例**: TC-EXT-019

**输入**: "从昨天开始"
**预期**: duration包含时间信息
**实际**: duration为空

**原因**: 当前duration_patterns中没有相对时间表达模式。

**建议**: 增加相对时间模式，如"从昨天开始"、"从今天早上开始"等。

### 问题8: 多轮对话持续时间提取失败
**影响用例**: TC-EXT-016

**输入**: "从昨天晚上开始"
**预期**: duration不为空
**实际**: duration为空

**原因**: 与问题7相同，缺少相对时间表达模式。

## 准确率评估

| 实体类型 | 准确率 | 说明 |
|---------|-------|------|
| symptom | 80% | 大部分常见症状能正确识别，但"喘息"等缺失 |
| temperature | 85% | 常见格式支持良好，"38度5"等口语格式不支持 |
| duration | 60% | 数字格式支持，相对时间表达缺失 |
| age_months | 75% | 常见格式支持，"一岁半"等需手动计算 |
| mental_state | 90% | 归一化效果良好 |
| frequency | 40% | 提取能力较弱，格式支持有限 |

## 改进建议

### 高优先级
1. **修复主症状覆盖问题**: 修改`merge_entities`逻辑，主症状应保持不变
2. **扩展symptom_map**: 增加"喘息"、"哮喘"、"皮疹"等词条
3. **改进频率提取**: 支持更多自然语言表达格式

### 中优先级
4. **支持口语化体温表达**: "38度5" -> "38.5度"
5. **增加相对时间表达**: "从昨天开始"、"刚刚发现"等
6. **优化呕吐处理逻辑**: 确保呕吐可作为主症状被识别

### 低优先级
7. **中文数字支持**: "三十八度" -> "38度"
8. **复合年龄表达**: "一岁半" -> "18个月"

## 结论

当前系统的诊断信息提取能力在常见场景下表现良好（63.6%测试通过率），但在以下方面需要改进：

1. **口语化表达支持不足**: 需要增加更多自然语言表达模式
2. **跨轮次累积逻辑需优化**: 主症状容易被后续输入覆盖
3. **边缘词条覆盖不全**: "喘息"等专业术语缺失
4. **时间/频率提取能力弱**: 需要扩展正则模式

建议优先修复高优先级问题，以提升整体提取准确率和用户体验。
