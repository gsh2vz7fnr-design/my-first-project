# Task Plan: 智能儿科分诊与护理助手系统

## Goal
构建一个基于大模型+硬编码状态机的智能儿科分诊与护理助手系统，为0-3岁婴幼儿的新手父母提供7x24小时即时响应、科学分诊、权威知识支持的医疗咨询服务，核心目标是有效分诊闭环率>80%，急症召回率100%。

## Current Phase
Phase 2

## Phases

### Phase 1: 需求分析与技术架构设计
- [x] 深入分析需求文档，提取核心功能模块
- [x] 设计系统整体架构（大模型+状态机混合架构）
- [x] 确定技术栈选型（LLM、RAG、数据库、前端框架）
- [x] 设计数据模型（用户档案、症状实体、知识库结构）
- [x] 明确关键指标与评估体系
- [x] 将发现记录到 findings.md
- **Status:** complete

### Phase 2: 知识库构建与RAG系统设计
- [x] 设计白名单知识库结构（默沙东、AAP、WHO等）
- [x] 定义知识库文档格式与元数据标准
- [x] 设计RAG检索策略（向量化、分块、召回）
- [x] 实现内容溯源机制（角标、原文片段）
- [x] 构建示例知识库数据（发烧、摔倒、呕吐等高频场景）
- **Status:** complete

### Phase 3: 智能分诊状态机实现
- [ ] 设计症状引导式分诊流程（发烧、摔倒、呕吐等）
- [ ] 实现危险信号熔断机制（<3个月发烧、惊厥等）
- [ ] 构建儿科医学规则引擎（基于AAP急诊指南）
- [ ] 实现三级分诊逻辑（立即就医/居家观察/线上问诊）
- [ ] 设计槽位填充与智能追问机制
- **Status:** pending

### Phase 4: 大模型集成与提示词工程
- [ ] 选择并集成大模型API（意图识别、实体提取）
- [ ] 设计核心System Prompt（身份界定、安全护栏）
- [ ] 实现意图识别模块（分诊/咨询/用药/护理）
- [ ] 实现症状实体提取（症状、程度、持续时间）
- [ ] 设计结构化输出模板（情绪承接、核心结论、注意点等）
- [ ] 实现流式输出（首字延迟<1.5s）
- **Status:** pending

### Phase 5: 安全机制与合规实现
- [ ] 实现违禁词过滤系统（通用红线+医疗红线）
- [ ] 构建黑名单词库（禁药、伪科学、高风险操作）
- [ ] 实现安全熔断与兜底话术
- [ ] 设计免责声明展示机制（首次进入、输出水印）
- [ ] 实现处方意图拦截（拒绝开药）
- [ ] 防幻觉机制（无源不答、拒答逻辑）
- **Status:** pending

### Phase 6: 用户档案与记忆系统
- [ ] 设计健康档案数据结构（月龄、体重、过敏史等）
- [ ] 实现对话后处理机制（异步提取实体）
- [ ] 实现档案写入逻辑（直接录入vs确认录入）
- [ ] 实现长短期记忆（会话内记忆+跨会话档案）
- [ ] 设计档案应用场景（个性化追问、风险预警）
- **Status:** pending

### Phase 7: 前端交互与用户体验
- [ ] 设计对话界面（输入框、气泡、角标）
- [ ] 实现流式输出展示（打字机效果）
- [ ] 实现内容溯源交互（点击角标展开原文）
- [ ] 实现引导提问按钮（3个后续问题）
- [ ] 设计免责声明展示（欢迎卡片、输入框占位符）
- [ ] 实现档案确认弹窗
- **Status:** pending

### Phase 8: 测试评估体系构建
- [ ] 构建100条测试用例数据集（覆盖不同风险等级）
- [ ] 实现自动化评估脚本（批量运行测试）
- [ ] 实现评估指标计算（分诊准确率、内容一致性、拒答率）
- [ ] 使用LLM-as-a-Judge进行质量评分
- [ ] 分析Bad Cases并优化
- **Status:** pending

### Phase 9: 系统集成与端到端测试
- [ ] 集成所有模块（分诊+问答+安全+档案）
- [ ] 进行端到端场景测试
- [ ] 性能优化（首字延迟、响应时间）
- [ ] 压力测试与并发测试
- [ ] 修复集成问题
- **Status:** pending

### Phase 10: 文档编写与交付
- [ ] 编写系统架构文档
- [ ] 编写API接口文档
- [ ] 编写部署运维文档
- [ ] 编写测试报告
- [ ] 准备演示Demo
- [ ] 交付给用户
- **Status:** pending

## Key Questions

1. ~~**大模型选型**：使用哪个大模型API？~~ ✅ **已确认：国产模型（通义千问/文心一言）**
2. ~~**前端技术栈**：Web应用还是移动应用？~~ ✅ **已确认：微信小程序**
3. ~~**MVP范围**：MVP版本包含哪些功能？~~ ✅ **已确认：智能分诊+循证问答+健康档案+用药咨询**
4. ~~**知识库来源**：如何获取知识库数据？~~ ✅ **已确认：手动整理示例数据（发烧、摔倒等高频场景）**
5. **状态机复杂度**：需要覆盖多少种症状场景？每个场景的决策树深度如何？
6. **RAG技术栈**：使用哪个向量数据库？（Pinecone、Weaviate、Milvus、或国产方案？）
7. **部署方式**：云服务器部署还是Serverless？如何保证7x24小时可用？
8. **数据隐私**：用户健康档案如何存储？是否需要加密？合规性如何保证？
9. **成本控制**：大模型API调用成本如何控制？是否需要缓存机制？
10. **用户反馈**：如何收集用户反馈？如何持续优化知识库和规则？

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| 混合架构（大模型+状态机） | 大模型提供NLU能力，状态机保证医疗安全，避免幻觉风险 |
| RAG白名单知识库 | 仅索引权威医学文献，防止幻觉，确保内容可溯源 |
| 危险信号熔断机制 | 医疗安全0容忍，任何高危症状必须100%召回并立即告警 |
| 违禁词后处理过滤 | 在LLM输出后进行硬匹配拦截，确保100%拦截禁药和高风险操作 |
| 结构化输出模板 | 避免大段文本，提供清晰的行动指令，降低用户认知负担 |
| 异步档案提取 | 不打断对话流程，后台自动沉淀结构化数据 |

## Errors Encountered

| Error | Attempt | Resolution |
|-------|---------|------------|
|       | 1       |            |

## Notes

- 这是一个医疗相关的高风险项目，安全性是第一优先级
- 需要特别注意：急症召回率必须100%，防幻觉准确率99.9%
- 建议采用MVP迭代策略，先实现核心分诊功能，再逐步扩展
- 知识库构建是重点和难点，需要大量医学专业知识
- 需要与用户确认技术栈选型、部署方式、迭代策略等关键决策
- 更新phase状态: pending → in_progress → complete
- 重读计划文件以保持目标清晰
- 记录所有错误以避免重复
