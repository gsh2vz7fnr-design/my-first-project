# 版本 v3.5 需求文档

> **版本**: v3.5
> **发布日期**: 2026-02-13
> **状态**: 开发中

---

## 一、需求概述

### 1.1 版本目标

v3.5 版本主要实现**用户认证系统**和**对话归档功能**，解决以下核心问题:

1. **用户身份管理**: 实现用户注册、登录和身份验证，支持跨会话数据持久化
2. **对话归档**: 支持将对话归档到健康档案，方便用户查看历史记录
3. **会话连续性**: 确保用户刷新页面后对话上下文不丢失

### 1.2 核心价值

- **用户体验提升**: 用户可以随时查看历史对话，无需担心数据丢失
- **数据持久化**: 对话数据与用户账号绑定，跨设备同步
- **健康档案完善**: 归档对话成为健康档案的一部分，方便医生查看

---

## 二、功能需求

### 2.1 用户认证系统

#### 2.1.1 软登录功能

**需求描述**:
- 用户首次访问时显示登录遮罩层
- 用户输入邮箱或昵称即可登录
- 无需密码验证，简化登录流程（适合 H5 快速体验场景）

**交互流程**:
1. 用户访问应用
2. 检测 `localStorage` 中是否有 `pediatric_user_id`
3. 如果没有，显示登录遮罩层
4. 用户输入邮箱/昵称
5. 前端生成 `user_id = "user_" + sanitized_email`
6. 调用 `POST /api/v1/auth/register` 注册用户
7. 保存 `user_id` 到 `localStorage`
8. 隐藏登录遮罩层，加载对话列表

**验证规则**:
- 邮箱/昵称不能为空
- 前端自动清理特殊字符，生成规范的 `user_id`

#### 2.1.2 用户验证功能

**需求描述**:
- 每次加载对话列表时验证用户身份
- 如果用户 ID 无效，清除本地数据并重新登录

**交互流程**:
1. 从 `localStorage` 读取 `user_id`
2. 调用 `GET /api/v1/auth/user/{user_id}` 验证
3. 如果验证失败，清除 `localStorage` 并显示登录遮罩层
4. 如果验证成功，加载对话列表

**容错处理**:
- 如果后端 API 不可用，使用本地验证 fallback
- 避免因后端故障导致用户无法使用应用

---

### 2.2 对话归档功能

#### 2.2.1 归档按钮

**需求描述**:
- 将右上角"清除对话"按钮改为"归档对话"按钮
- 使用文件夹图标（📁）替代垃圾桶图标

**位置**:
- 前端: `frontend/components.js:111-118`
- 触发事件: `archive-conversation`

#### 2.2.2 归档流程

**需求描述**:
- 点击"归档"按钮后，查询对话涉及的成员
- 如果只有单个成员，显示确认对话框后自动归档
- 如果有多个成员，显示成员选择器，用户选择归档到哪个成员

**交互流程**:
1. 用户点击"归档"按钮
2. 前端调用 `GET /api/v1/conversations/{id}/members` 查询涉及成员
3. 判断成员数量:
   - 0个: 直接归档（无关联成员）
   - 1个: 显示确认对话框 → 归档到该成员
   - 多个: 显示成员选择器 → 用户选择 → 归档到选定成员
4. 调用 `POST /api/v1/conversations/{id}/archive` 归档对话
5. 显示成功提示
6. 清空当前对话，重新加载对话列表

**成员选择器 UI**:
```
┌─────────────────────────────────────┐
│ 选择归档成员                        │
├─────────────────────────────────────┤
│ 本次对话涉及多位成员，请选择归档到  │
│ 哪个成员的健康档案：                │
│                                     │
│ ○ 大宝 (子女 · 5岁)                │
│ ● 二宝 (子女 · 3岁)                │
│                                     │
│     [取消]    [确认归档]            │
└─────────────────────────────────────┘
```

#### 2.2.3 归档提醒

**需求描述**:
- 页面关闭前提示用户归档未保存的对话
- 对话持续30分钟后提示用户归档

**实现方式**:

1. **beforeunload 事件**:
   - 监听 `window.beforeunload` 事件
   - 如果有活跃对话且持续时间超过5分钟，弹出确认提示
   - 提示内容: "您有未归档的对话，确定要离开吗？"

2. **30分钟定时器**:
   - 对话开始时启动计时器
   - 30分钟后显示 Banner 提示: "💡 提示：对话已持续30分钟，建议归档保存到健康档案"
   - 用户可以选择立即归档或继续对话

**计时器管理**:
- 创建新对话时启动计时器
- 发送首条消息时启动计时器（避免空对话计时）
- 归档对话后清除计时器

#### 2.2.4 归档状态显示

**需求描述**:
- 侧边栏中已归档对话显示📁图标和"已归档"标签
- 已归档对话不显示删除按钮（只读）
- 点击已归档对话时加载历史记录（只读模式）

**UI 样式**:
```
对话列表:
┌─────────────────────────────────────┐
│ 📁 宝宝发烧咨询          已归档     │
│ 2小时前 · 12条消息                  │
├─────────────────────────────────────┤
│ 💬 宝宝咳嗽问题          🗑         │
│ 刚刚 · 3条消息                      │
└─────────────────────────────────────┘
```

---

### 2.3 会话连续性

#### 2.3.1 刷新页面后恢复对话

**需求描述**:
- 用户刷新页面后自动加载最近对话
- 恢复对话上下文，无需重新选择

**实现方式**:
1. 页面加载时检查 `localStorage` 中的 `user_id`
2. 调用 `GET /api/v1/chat/conversations/{user_id}` 加载对话列表
3. 如果 `conversationId` 为空且对话列表不为空，自动加载最近对话
4. 调用 `GET /api/v1/chat/history/{conversation_id}` 加载历史消息
5. 设置侧边栏活跃状态

#### 2.3.2 跨设备同步

**需求描述**:
- 用户在不同设备登录同一账号，对话数据自动同步
- 归档记录在所有设备上同步显示

**实现方式**:
- 所有对话数据存储在后端数据库
- 前端只缓存 `user_id`
- 每次加载时从后端拉取最新数据

---

## 三、接口定义

### 3.1 用户认证接口

#### 3.1.1 注册/登录用户

```http
POST /api/v1/auth/register
Content-Type: application/json

{
  "user_id": "user_parentexamplecom",
  "display_name": "parent@example.com"
}

Response 200:
{
  "status": "success",
  "data": {
    "user_id": "user_parentexamplecom",
    "created_at": "2026-02-13T10:30:00Z",
    "last_login": "2026-02-13T10:30:00Z"
  }
}
```

#### 3.1.2 验证用户

```http
GET /api/v1/auth/user/{user_id}

Response 200 (用户存在):
{
  "status": "success",
  "data": {
    "valid": true,
    "user_id": "user_parentexamplecom",
    "nickname": "parent@example.com",
    "last_login": "2026-02-13T10:30:00Z"
  }
}

Response 404 (用户不存在):
{
  "status": "error",
  "data": {
    "valid": false
  }
}
```

---

### 3.2 归档接口

#### 3.2.1 查询对话成员

```http
GET /api/v1/conversations/{conversation_id}/members

Response 200:
{
  "status": "success",
  "data": {
    "members": [
      {
        "id": "member_baby_001",
        "name": "大宝",
        "relationship": "child",
        "age": "5岁"
      },
      {
        "id": "member_baby_002",
        "name": "二宝",
        "relationship": "child",
        "age": "3岁"
      }
    ]
  }
}
```

#### 3.2.2 归档对话

```http
POST /api/v1/conversations/{conversation_id}/archive
Content-Type: application/json

{
  "member_id": "member_baby_001",
  "user_id": "user_parentexamplecom"
}

Response 200:
{
  "status": "success",
  "data": {
    "conversation_id": "conv_123456",
    "archived": true,
    "archived_to_member_id": "member_baby_001",
    "archived_at": "2026-02-13T11:00:00Z"
  }
}
```

---

## 四、非功能需求

### 4.1 性能要求

- 登录响应时间 < 500ms
- 归档操作响应时间 < 1s
- 页面刷新后恢复对话 < 2s

### 4.2 兼容性

- 支持 iOS Safari 12+
- 支持 Android Chrome 80+
- 支持微信内置浏览器

### 4.3 安全性

- `user_id` 使用确定性生成算法，避免碰撞
- 归档操作需验证 `user_id` 权限
- 已归档对话不允许删除或修改（只读）

---

## 五、验收标准

### 5.1 功能验收

- [ ] 首次登录可以正常注册用户
- [ ] 老用户重新登录可以加载历史对话
- [ ] 单成员对话可以自动归档
- [ ] 多成员对话可以选择归档成员
- [ ] 页面关闭前提示归档
- [ ] 30分钟超时提醒显示
- [ ] 已归档对话显示只读标记
- [ ] 刷新页面后对话上下文恢复
- [ ] 跨设备数据同步正常

### 5.2 测试覆盖

- [ ] 10个 E2E 测试场景全部通过
- [ ] 单元测试覆盖率 > 85%
- [ ] 集成测试覆盖所有 API 端点

### 5.3 文档完整性

- [ ] 需求文档（本文件）
- [ ] 解决方案文档（`solution.md`）
- [ ] 测试用例文档（`test_cases.md`）
- [ ] Bug 记录文档（`bugs.md`）
- [ ] 更新日志（`CHANGELOG.md`）

---

## 六、风险与依赖

### 6.1 技术风险

- **前端无模块系统**: 所有组件在 `components.js` 中，文件较大（2000+ 行）
- **后端 API 依赖**: 如果后端未实现 API，前端需提供 fallback

### 6.2 依赖项

- **Agent A**: 实现归档相关 API（`/conversations/{id}/members`, `/conversations/{id}/archive`）
- **Agent B**: 实现用户认证 API（`/auth/register`, `/auth/user/{id}`）

### 6.3 缓解措施

- 前端实现 fallback 逻辑，后端 API 不可用时仍可正常使用
- 使用 `try-catch` 包裹所有 API 调用，避免崩溃

---

*最后更新: 2026-02-13 by Agent C*
