# 健康档案模块 — 测试用例规划书 (Test Strategy Plan)

> **模块范围**：档案首页 (Health Dashboard) + 成员信息编辑页 (Member Edit Page)
> **版本**：v1.0
> **日期**：2026-02-07
> **优先级定义**：P0 = 阻断级（不通过则禁止上线）| P1 = 高优 | P2 = 中优 | P3 = 低优

---

## Section 1: 测试范围与策略 (Scope & Strategy)

### 1.1 单元测试 (Unit Test)

以下核心逻辑**必须**编写单元测试，覆盖正常值、边界值、异常值：

| # | 测试对象 | 文件位置 | 说明 |
|---|---------|---------|------|
| U-1 | **BMI 计算函数** | `profile_service.py: upsert_vital_signs()` | 公式：`weight_kg / (height_cm/100)²`，结果保留 1 位小数 |
| U-2 | **BMI 状态分级** | `profile_service.py: _calculate_bmi_status()` | 四档：<18.5 偏瘦 / 18.5-24 正常 / 24-28 偏胖 / ≥28 肥胖 |
| U-3 | **成员创建校验** | `profile_service.py: create_member()` | 必填项：name, relationship, gender, birth_date |
| U-4 | **身份证号不可变规则** | `profile_service.py: update_member()` | id_card_number 一旦设置不可修改 |
| U-5 | **年龄自动计算** | 基于 `birth_date` 计算当前月龄/年龄 | 用于分诊上下文注入 |
| U-6 | **待确认记录去重** | `profile_service.py: apply_updates_from_message()` | 相同过敏原不应重复生成待确认记录 |
| U-7 | **Pydantic 模型校验** | `models/user.py` | 枚举值越界、必填字段缺失时应抛出 ValidationError |

### 1.2 集成测试 (UI/Integration Test)

以下交互链路需要**端到端跑通**：

| # | 链路描述 | 涉及组件 |
|---|---------|---------|
| INT-1 | 创建成员 → 填写身高体重 → 首页展示 BMI 卡片 | 编辑页 → POST API → Dashboard `updateBMI()` |
| INT-2 | 编辑页修改体重 → 返回首页 → BMI 实时刷新 | PUT vital-signs → GET member → Dashboard 刷新 |
| INT-3 | 对话中提到过敏 → 30min 后提取 → 洞察卡片展示 → 用户确认 → 写入档案 | chat → conversation_service → profile_service → pending → confirm |
| INT-4 | 添加过敏记录 → 首页过敏计数 +1 | POST allergy → GET history → Dashboard `updateHistoryCounts()` |
| INT-5 | 删除成员 → 首页成员列表刷新 | DELETE member → GET members |
| INT-6 | 多成员切换 → 各成员数据独立展示 | 成员选择器 → GET member/{id} → Dashboard 全量刷新 |
| INT-7 | 首次进入空档案 → 显示空状态 → 引导填写 | GET members (空) → 空状态 UI |

### 1.3 边界与异常测试 (Edge Cases) — **重点**

| # | 场景 | 预期行为 | 优先级 |
|---|------|---------|--------|
| E-1 | 身高输入 **0 cm** | BMI 不计算，提示"请输入有效身高" | P0 |
| E-2 | 身高输入 **负数**（如 -170） | 拒绝保存，前端校验 + 后端兜底 | P0 |
| E-3 | 体重输入 **1000 kg** | 拒绝保存，提示数值不合理（儿科场景体重上限建议 200kg） | P0 |
| E-4 | 身高输入 **0.5 cm**（极小值） | 拒绝或警告，婴儿最小出生身长约 25cm | P1 |
| E-5 | 身高 = 170cm, 体重 = 0.1kg | BMI 计算结果极小（≈0.0），状态应为"偏瘦" | P1 |
| E-6 | **断网时提交**表单 | 前端应提示网络错误，不丢失已填数据 | P1 |
| E-7 | **并发编辑**：两个设备同时修改同一成员 | 后写入者覆盖，不产生脏数据 | P2 |
| E-8 | 出生日期填写**未来日期** | 拒绝保存，提示"出生日期不能晚于今天" | P0 |
| E-9 | 出生日期填写 **1900-01-01**（极端历史日期） | 允许保存但年龄计算应正确（126 岁） | P2 |
| E-10 | 姓名输入**超长字符串**（>200字符） | 截断或拒绝，不导致数据库异常 | P2 |
| E-11 | 姓名输入**特殊字符** `<script>alert(1)</script>` | XSS 防护：前端转义 + 后端过滤 | P0 |
| E-12 | 身份证号设置后**尝试修改** | 接口返回错误，身份证号保持不变 | P1 |
| E-13 | 同一用户创建**大量成员**（如 100 个） | 系统不崩溃，列表分页或滚动正常 | P3 |
| E-14 | 血糖值输入 **-5** 或 **999** | 拒绝保存，提示数值不合理 | P1 |
| E-15 | 血压收缩压 < 舒张压 | 警告用户数据可能填反 | P2 |

---

## Section 2: 核心用例清单 (Test Cases Checklist)

### 2.1 档案首页 (Health Dashboard)

| Case ID | 场景 | 前置条件 | 操作步骤 | 预期结果 | 优先级 |
|---------|------|---------|---------|---------|--------|
| TC-HP-001 | 首次进入档案页（空状态） | 用户无任何成员数据 | 点击底部"健康档案"Tab | 显示空状态引导页，提示"添加家庭成员" | P0 |
| TC-HP-002 | 有成员时进入档案页 | 已创建 1 个成员，身高 75cm，体重 9.5kg | 点击"健康档案"Tab | BMI 卡片显示：BMI=16.9，状态"偏瘦"；身高 75cm；体重 9.5kg | P0 |
| TC-HP-003 | BMI 状态正确显示 — 正常 | 成员身高 100cm，体重 20kg | 进入档案首页 | BMI=20.0，状态标签显示"正常"（绿色） | P0 |
| TC-HP-004 | BMI 状态正确显示 — 偏胖 | 成员身高 100cm，体重 26kg | 进入档案首页 | BMI=26.0，状态标签显示"偏胖"（橙色） | P1 |
| TC-HP-005 | BMI 状态正确显示 — 肥胖 | 成员身高 100cm，体重 30kg | 进入档案首页 | BMI=30.0，状态标签显示"肥胖"（红色） | P1 |
| TC-HP-006 | 体征数据未填写 | 成员已创建但未填身高体重 | 进入档案首页 | BMI 卡片显示"--"，身高体重显示"待完善" | P0 |
| TC-HP-007 | 血压血糖空状态 | 未填写血压血糖 | 查看指标网格区域 | 血压、血糖卡片显示"--" | P1 |
| TC-HP-008 | 过敏记录计数 | 已添加 3 条过敏记录 | 查看健康史区域 | 过敏卡片右上角显示"3" | P1 |
| TC-HP-009 | 多成员切换 | 已创建 2 个成员（宝宝A、宝宝B） | 在成员选择器切换到宝宝B | 所有卡片数据刷新为宝宝B的数据 | P0 |
| TC-HP-010 | 健康习惯展示 | 已设置饮食习惯=规律、运动=每周 | 查看习惯区域 | 显示"饮食规律"、"每周运动" | P2 |

### 2.2 成员信息编辑页 (Member Edit Page)

| Case ID | 场景 | 前置条件 | 操作步骤 | 预期结果 | 优先级 |
|---------|------|---------|---------|---------|--------|
| TC-ME-001 | 创建新成员 — 必填项完整 | 无 | 填写姓名"小明"、关系"孩子"、性别"男"、出生日期"2025-06-15" → 提交 | 创建成功，返回成员列表，新成员可见 | P0 |
| TC-ME-002 | 创建新成员 — 缺少必填项 | 无 | 只填姓名，不填性别和出生日期 → 提交 | 提交失败，高亮缺失字段，提示"请填写必填信息" | P0 |
| TC-ME-003 | 编辑身高体重 → BMI 自动计算 | 已有成员 | 输入身高 80cm、体重 10kg → 保存 | 保存成功，BMI 自动计算为 15.6，状态"偏瘦" | P0 |
| TC-ME-004 | 修改体重 → 返回首页验证联动 | 成员原体重 10kg | 修改体重为 12kg → 保存 → 返回首页 | 首页 BMI 卡片即时更新为新值 | P0 |
| TC-ME-005 | 身份证号首次设置 | 身份证号为空 | 输入身份证号 → 保存 | 保存成功 | P1 |
| TC-ME-006 | 身份证号二次修改 | 身份证号已设置 | 尝试修改身份证号 → 保存 | 保存失败，提示"身份证号不可修改" | P1 |
| TC-ME-007 | 添加过敏记录 | 已有成员 | 点击"添加过敏" → 填写过敏原"鸡蛋"、反应"呕吐"、严重程度"中度" → 保存 | 过敏列表新增一条记录 | P0 |
| TC-ME-008 | 添加既往病史 | 已有成员 | 点击"添加病史" → 填写疾病名"热性惊厥"、诊断日期 → 保存 | 病史列表新增一条记录 | P1 |
| TC-ME-009 | 添加用药记录 | 已有成员 | 填写药名"布洛芬"、剂量"5ml"、频率"每6小时" → 保存 | 用药列表新增一条记录 | P1 |
| TC-ME-010 | 删除成员 | 已有成员"小明" | 点击删除 → 确认弹窗 → 确认删除 | 成员从列表消失，相关数据全部清除 | P1 |

### 2.3 数据联动与刷新 (Data Sync)

| Case ID | 场景 | 前置条件 | 操作步骤 | 预期结果 | 优先级 |
|---------|------|---------|---------|---------|--------|
| TC-DS-001 | 编辑页保存 → 首页即时刷新 | 成员身高 80cm，体重 10kg | 编辑页修改体重为 11kg → 保存 → 返回首页 | 首页 BMI 从 15.6 变为 17.2 | P0 |
| TC-DS-002 | 添加过敏 → 首页计数更新 | 过敏记录 0 条 | 编辑页添加 1 条过敏记录 → 返回首页 | 首页过敏计数从 0 变为 1 | P1 |
| TC-DS-003 | 对话提取 → 洞察卡片展示 | 对话中提到"宝宝对牛奶过敏" | 等待异步提取完成 → 打开档案页 | 顶部出现洞察卡片："检测到宝宝可能对牛奶过敏" | P0 |
| TC-DS-004 | 洞察卡片确认 → 写入档案 | 有待确认的过敏记录 | 点击洞察卡片"确认加入" | 过敏记录写入档案，洞察卡片消失，过敏计数 +1 | P0 |
| TC-DS-005 | 洞察卡片忽略 | 有待确认记录 | 点击"忽略" | 卡片消失，档案不变 | P1 |
| TC-DS-006 | 洞察卡片修改 | 有待确认记录"鸡蛋过敏" | 点击"修改" → 改为"蛋黄过敏" → 确认 | 以修改后的内容写入档案 | P2 |

### 2.4 BMI 计算准确性 (Data Accuracy — 医疗敏感)

| Case ID | 身高 (cm) | 体重 (kg) | 预期 BMI | 预期状态 | 优先级 |
|---------|-----------|-----------|----------|---------|--------|
| TC-BMI-001 | 50 | 3.5 | 14.0 | 偏瘦 | P0 |
| TC-BMI-002 | 75 | 9.5 | 16.9 | 偏瘦 | P0 |
| TC-BMI-003 | 100 | 20 | 20.0 | 正常 | P0 |
| TC-BMI-004 | 110 | 25 | 20.7 | 正常 | P0 |
| TC-BMI-005 | 120 | 35 | 24.3 | 偏胖 | P0 |
| TC-BMI-006 | 150 | 65 | 28.9 | 肥胖 | P0 |
| TC-BMI-007 | 18.5 (边界) | 170 | — | 计算正确即可 | P1 |
| TC-BMI-008 | 100 | 18.5 | 18.5 | **边界**：应为"正常"（≥18.5） | P0 |
| TC-BMI-009 | 100 | 24 | 24.0 | **边界**：应为"偏胖"（≥24） | P0 |
| TC-BMI-010 | 100 | 28 | 28.0 | **边界**：应为"肥胖"（≥28） | P0 |

### 2.5 表单校验 (Form Validation)

| Case ID | 场景 | 输入值 | 预期结果 | 优先级 |
|---------|------|-------|---------|--------|
| TC-FV-001 | 身高为空 | height_cm = null | 提示"请输入身高" | P0 |
| TC-FV-002 | 身高为 0 | height_cm = 0 | 提示"身高必须大于 0" | P0 |
| TC-FV-003 | 身高为负数 | height_cm = -10 | 提示"请输入有效身高" | P0 |
| TC-FV-004 | 身高超大值 | height_cm = 300 | 提示"身高数值不合理"（儿科上限约 200cm） | P1 |
| TC-FV-005 | 体重为 0 | weight_kg = 0 | 提示"体重必须大于 0" | P0 |
| TC-FV-006 | 体重为负数 | weight_kg = -5 | 提示"请输入有效体重" | P0 |
| TC-FV-007 | 体重超大值 | weight_kg = 1000 | 提示"体重数值不合理" | P0 |
| TC-FV-008 | 出生日期为未来 | birth_date = 2027-01-01 | 提示"出生日期不能晚于今天" | P0 |
| TC-FV-009 | 姓名为空 | name = "" | 提示"请输入姓名" | P0 |
| TC-FV-010 | 非数字输入身高 | height_cm = "abc" | 前端阻止输入或提示"请输入数字" | P1 |
| TC-FV-011 | 小数精度 | height_cm = 75.123456 | 接受并正常保存（后端截断或四舍五入） | P2 |
| TC-FV-012 | 血压收缩压 < 舒张压 | systolic=60, diastolic=120 | 警告"收缩压应大于舒张压" | P2 |

### 2.6 异常与容错 (Error Handling)

| Case ID | 场景 | 操作步骤 | 预期结果 | 优先级 |
|---------|------|---------|---------|--------|
| TC-EH-001 | 网络断开时保存 | 断开网络 → 点击保存 | 显示"网络连接失败，请检查网络"，表单数据不丢失 | P1 |
| TC-EH-002 | 服务端 500 错误 | 后端异常 → 前端提交 | 显示"服务器繁忙，请稍后重试"，不展示技术错误信息 | P1 |
| TC-EH-003 | 成员不存在 | 访问已删除成员的 URL | 返回 404，前端显示"成员不存在"并引导返回 | P1 |
| TC-EH-004 | 重复提交 | 快速连续点击保存按钮 2 次 | 只执行一次保存，按钮防抖/禁用 | P1 |
| TC-EH-005 | 超时处理 | 后端响应超过 10s | 前端显示加载超时提示 | P2 |
| TC-EH-006 | 数据库锁冲突 | 并发写入同一成员 | 不产生数据损坏，后写入者覆盖 | P2 |

### 2.7 安全测试 (Security)

| Case ID | 场景 | 操作步骤 | 预期结果 | 优先级 |
|---------|------|---------|---------|--------|
| TC-SEC-001 | XSS 注入 — 姓名字段 | 输入 `<script>alert('xss')</script>` 作为姓名 | 内容被转义，不执行脚本 | P0 |
| TC-SEC-002 | SQL 注入 — 搜索字段 | 输入 `'; DROP TABLE members; --` | 查询正常，数据库不受影响 | P0 |
| TC-SEC-003 | 越权访问 | 用户 A 尝试访问用户 B 的成员数据 | 返回 403 Forbidden | P0 |
| TC-SEC-004 | 身份证号脱敏展示 | 查看已填写身份证号的成员 | 身份证号中间位数用 * 遮蔽 | P1 |

---

## Section 3: 自动化测试提示词 (Prompts for Copilot)

### Prompt A: BMI 计算单元测试

```
你是一个资深 Python 测试工程师。请为以下 BMI 计算逻辑编写完整的 pytest 单元测试。

## 被测函数逻辑

1. `upsert_vital_signs(vital_signs)`:
   - 当 height_cm > 0 且 weight_kg > 0 时，计算 BMI = weight_kg / (height_cm / 100)²
   - 结果保留 1 位小数（round(..., 1)）
   - 调用 _calculate_bmi_status(bmi) 确定状态

2. `_calculate_bmi_status(bmi)`:
   - bmi < 18.5 → "underweight"
   - 18.5 ≤ bmi < 24 → "normal"
   - 24 ≤ bmi < 28 → "overweight"
   - bmi ≥ 28 → "obese"

## 测试要求

请覆盖以下场景，每个场景写一个独立的 test 函数：

### 正常值测试
- 新生儿：身高 50cm，体重 3.5kg → BMI=14.0, underweight
- 6月龄婴儿：身高 75cm，体重 9.5kg → BMI=16.9, underweight
- 学龄前儿童：身高 100cm，体重 20kg → BMI=20.0, normal
- 青少年：身高 150cm，体重 65kg → BMI=28.9, obese

### 边界值测试（重点！）
- BMI 恰好 = 18.5（身高 100cm，体重 18.5kg）→ 应为 normal（不是 underweight）
- BMI 恰好 = 24.0（身高 100cm，体重 24kg）→ 应为 overweight（不是 normal）
- BMI 恰好 = 28.0（身高 100cm，体重 28kg）→ 应为 obese（不是 overweight）

### 异常值测试
- 身高 = 0 → 不应计算 BMI（跳过或抛异常）
- 体重 = 0 → 不应计算 BMI
- 身高 = -10 → 不应计算 BMI
- 体重 = -5 → 不应计算 BMI
- 身高 = 0.01（极小值）→ BMI 极大，验证不崩溃
- 体重 = 0.01（极小值）→ BMI 极小，验证不崩溃

### 精度测试
- 身高 65cm，体重 7.3kg → 验证 round 到 1 位小数的正确性
- 身高 83.5cm，体重 11.2kg → 验证小数输入的处理

## 输出格式
- 使用 pytest + parametrize 减少重复代码
- 每个 test 函数有清晰的中文注释说明测试意图
- 使用 pytest.approx() 处理浮点精度问题
```

### Prompt B: 端到端测试 — 修改体重 → 首页 BMI 刷新

```
你是一个资深前端测试工程师。请为以下端到端场景编写测试描述（可用 Playwright / Cypress / 手动测试脚本格式）。

## 测试场景：修改体重后首页 BMI 联动更新

### 背景
这是一个儿科健康档案 App（移动端 H5）。用户在"成员编辑页"修改体重后，返回"档案首页"，BMI 卡片应即时显示新的计算结果。

### 技术栈
- 前端：原生 JS（无框架），通过 fetch 调用 REST API
- 后端：FastAPI + SQLite
- API：PUT /api/v1/profile/members/{member_id}/vital-signs

### 测试步骤

**前置条件：**
- 已登录用户 user_001
- 已创建成员 member_001（姓名：小明，身高：80cm，体重：10kg）
- 当前首页 BMI 显示：15.6（偏瘦）

**操作流程：**
1. 在档案首页，确认 BMI 卡片显示 "15.6" 和 "偏瘦"
2. 点击 BMI 卡片或编辑按钮，进入成员编辑页
3. 找到"体重"输入框，清空原值，输入 "12"
4. 点击"保存"按钮
5. 等待保存成功提示（Toast 或状态变化）
6. 返回档案首页（点击返回按钮或底部 Tab）
7. 检查 BMI 卡片

**预期结果：**
- BMI 值从 "15.6" 变为 "18.8"
- BMI 状态从 "偏瘦" 变为 "正常"（因为 18.8 ≥ 18.5）
- 体重显示从 "10kg" 变为 "12kg"
- 身高保持 "80cm" 不变
- 更新时间显示为当前时间

**异常分支（也需要测试）：**
- 分支 A：保存时网络断开 → 应提示错误，体重保持原值 10kg
- 分支 B：输入体重为 0 → 保存按钮禁用或提示错误
- 分支 C：输入体重为非数字 "abc" → 前端阻止输入
- 分支 D：快速连续点击保存 → 只执行一次请求

### 断言清单
请为每个步骤编写具体的断言（assertion），包括：
- DOM 元素选择器（如 `.bmi-value`, `.bmi-status`）
- 预期文本内容
- API 请求的 request body 和 response status
- 页面加载状态（loading → loaded）
```

---

## 附录 A: 测试数据准备

### 标准测试用户

| 用户 ID | 成员 | 身高 | 体重 | 过敏史 | 病史 |
|---------|------|------|------|--------|------|
| user_001 | 小明 (6月龄男婴) | 75cm | 9.5kg | 鸡蛋 | 无 |
| user_002 | 小红 (2岁女童) | 90cm | 13kg | 无 | 热性惊厥 |
| user_003 | 空档案用户 | — | — | — | — |

### BMI 边界值速查表

| BMI 值 | 状态 | 身高 100cm 时对应体重 |
|--------|------|---------------------|
| 18.4 | 偏瘦 | 18.4 kg |
| 18.5 | **正常**（边界） | 18.5 kg |
| 23.9 | 正常 | 23.9 kg |
| 24.0 | **偏胖**（边界） | 24.0 kg |
| 27.9 | 偏胖 | 27.9 kg |
| 28.0 | **肥胖**（边界） | 28.0 kg |

## 附录 B: 测试优先级执行顺序

| 阶段 | 范围 | 用例数 | 说明 |
|------|------|--------|------|
| **Phase 1 (冒烟测试)** | 所有 P0 用例 | ~25 条 | 每次构建必跑，阻断级 |
| **Phase 2 (回归测试)** | P0 + P1 | ~40 条 | 每次发版前跑 |
| **Phase 3 (全量测试)** | P0 + P1 + P2 + P3 | ~55 条 | 大版本发布前全量覆盖 |
