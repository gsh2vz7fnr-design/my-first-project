# 智能儿科分诊与护理助手架构评审报告

作为首席架构师，我对当前代码库（`pediatric-assistant`）进行了深入的审计。项目整体结构清晰，核心业务链路（分诊、RAG、安全风控）已初具雏形，但在**检索精度（RAG）**、**系统鲁棒性**及**部分关键技术选型**上，与需求文档存在显著差距。

以下是详细的差异分析与优化建议：

## 一、 核心架构与需求差距分析

### 1. 🚨 RAG 检索链路严重缺失（高危）
需求文档明确要求采用 **"混合检索 + 重排序"** 架构，但当前实现过于简化，无法满足 "99.9% 防幻觉" 的高标准。

*   **缺失重排序 (Reranking)**：
    *   **现状**：`rag_service.py` 仅使用 Embedding (Bi-Encoder) 进行余弦相似度排序。
    *   **需求**：文档要求 "Top-50 文档进行 Cross-Encoder (如 BGE-Reranker) 精细打分"。
    *   **风险**：单纯依赖向量检索，在医学长尾问题上（如"美林和泰诺林间隔"）容易召回语义相似但逻辑相反的错误文档。
*   **混合检索策略未实现**：
    *   **现状**：代码逻辑是 "若远程 Embedding 可用则用向量检索，否则降级为本地关键词匹配"。
    *   **需求**：Semantic Search (70%) + Keyword Search (30%) 同时进行并加权。
    *   **风险**：无法兼顾 "语义理解"（模糊描述）与 "精确匹配"（专有名词/药名）。
*   **结构化切分 (Structure-Aware Splitting) 不足**：
    *   **现状**：`fever.json` 虽有结构，但系统仅返回单一 Entry 内容。
    *   **需求**：检索命中 Child Chunk 后，需召回 Parent Doc（完整章节上下文）给 LLM。
    *   **风险**：断章取义。例如检索到 "禁忌症"，但 LLM 不知道这是针对哪种药的禁忌症。

### 2. ⚠️ 异步 ETL 机制脆弱（中危）
*   **现状**：`profile_service.py` 使用 `asyncio.sleep(30 * 60)` 实现 30 分钟延迟提取。
*   **问题**：这是**进程内内存级**的实现。一旦服务重启、Crash 或部署更新，所有挂起的 `sleep` 任务将直接丢失，导致用户档案数据永久丢失。
*   **建议**：必须引入持久化任务队列（如 Redis Key Expiration Event 或 Celery/RQ），确保任务在进程重启后仍能执行。

### 3. ⚠️ 分诊规则引擎的硬编码风险
*   **现状**：`triage_engine.py` 中将 `< 3个月` 等核心医学规则硬编码在 Python 代码中。
*   **问题**：医学指南更新频繁（如 AAP 指南修订），硬编码导致规则调整需要发版部署，灵活性差。
*   **建议**：将规则逻辑完全抽离为配置文件（如 `rules.yaml`）或使用轻量级规则引擎表达式，实现热更新。

## 二、 详细代码级审查

### ✅ 亮点（已达标部分）
1.  **安全风控体系**：`SafetyFilter` 和 `StreamSafetyFilter` 严格实现了黑名单与流式阻断，符合 "护栏优先" 原则。
2.  **意图识别路由**：`chat.py` 能够正确区分 `triage`（分诊）与 `consult`（咨询）意图，并优先处理危险信号。
3.  **槽位补全**：`get_missing_slots` 逻辑实现了基于档案的自动填充，减少了用户重复输入。

### ❌ 不合理/待优化点（Bad Smells）

| 模块 | 文件位置 | 问题描述 | 建议方案 |
| :--- | :--- | :--- | :--- |
| **RAG** | `rag_service.py` | 缺少 BGE-Reranker；缺少混合检索加权逻辑。 | 引入 `CrossEncoder` 模型；实现 BM25 + Vector 加权融合。 |
| **Profile** | `profile_service.py` | `schedule_delayed_extraction` 使用 `asyncio.sleep`，不可靠。 | 使用 Redis TTL 或简单的 DB 轮询任务表。 |
| **Data** | `fever.json` | 数据结构扁平，缺乏 `parent_id` 关联。 | 增加层级结构，检索返回时包含父级 Context。 |
| **Triage** | `triage_engine.py` | `_triage_fever` 方法中硬编码了 "3个月"、"48小时" 等阈值。 | 将阈值参数化，移至 `triage_rules/*.json` 配置中。 |
| **LLM** | `llm_service.py` | 提示词中缺少对 "当前时间" 的感知。 | System Prompt 注入 `Current Date`，避免计算月龄出错。 |

## 三、 改进计划建议

建议按以下优先级进行重构：

1.  **P0 (Critical)**: 修复 **RAG 检索链路**。引入重排序模型，确保医学建议的准确性。
2.  **P1 (High)**: 改造 **异步任务队列**。替换 `asyncio.sleep`，保证档案提取的可靠性。
3.  **P2 (Medium)**: 优化 **规则配置化**。将硬编码的医学阈值提取到配置文件。

---
**结论**：当前版本是一个合格的 "原型 (MVP)"，但距离 "生产级 (Production-Ready)" 尚缺 20% 的关键工程实现，主要集中在 **检索精度** 与 **系统稳定性** 上。