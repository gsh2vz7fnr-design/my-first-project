# 实施计划：健康档案模块测试完善

根据 `test_plan.md` 和现有代码的差距分析，制定以下实施计划，旨在补全核心业务逻辑的测试覆盖，特别是边界条件和数据校验。

1\. 补充测试用例 (Test Implementation)

创建两个新的测试文件，覆盖现有测试未涉及的领域：

### 1.1 `backend/tests/test_profile_edge_cases.py`

**覆盖范围**: 边界值与异常校验 (Edge Cases)

* **E-3**: 体重超大值校验 (如 1000kg 应报错)

* **E-4**: 身高极小值校验 (如 0.5cm 应报错)

* **E-14**: 血糖值合理性校验 (范围 0-50 mmol/L)

* **E-15**: 血压逻辑校验 (收缩压 必须大于 舒张压)

* **U-5**: 年龄/月龄自动计算逻辑 (验证根据 birth\_date 计算 age\_months 的准确性)

### 1.2 `backend/tests/test_profile_deduplication.py`

**覆盖范围**: 业务逻辑完整性

* **U-6**: 待确认记录去重逻辑 (验证 `apply_updates_from_message` 不会生成重复的待确认项)

## 2. 完善业务逻辑 (Code Refactoring)

修改 `backend/app/services/profile_service.py` 以通过上述新测试：

### 2.1 增强 `upsert_vital_signs`

* 添加数值范围检查：

  * 身高: 20cm - 250cm

  * 体重: 1kg - 300kg

  * 血糖: 0.5 - 50.0 mmol/L

* 添加逻辑关联检查：

  * 收缩压 > 舒张压

### 2.2 实现年龄计算 Helper

* 在 `MemberProfileService` 中添加 `calculate_age_months(birth_date: str) -> int` 方法。

* (可选) 在获取成员信息时自动计算并返回当前月龄。

## 3. 执行与验证 (Execution & Verification)

1. 运行新创建的测试，预期初次运行失败 (Red)。
2. 应用代码变更。
3. 再次运行所有测试，确保全部通过 (Green)。
4. 输出最终测试报告。

## 进度追踪

* [ ] 创建边界测试文件

* [ ] 创建去重测试文件

* [ ] 增强 profile\_service.py 校验逻辑

* [ ] 验证所有测试通过

