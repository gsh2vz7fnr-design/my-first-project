# 重构计划：智能儿科助手 (Smart Pediatric Assistant)

本计划旨在解决实体提取失效、UI 交互缺陷及分诊流程中断等核心问题。我们将引入中央状态管理，优化前后端交互协议，并增强系统的鲁棒性。

## 1. 后端重构：状态管理与分诊逻辑 (Python)

### 1.1 增强 `MedicalContext` (中央状态管理器)
**目标**：建立严格的数据模型，支持增量更新。
- **文件**：`backend/app/models/medical_context.py`
- **任务**：
    - 定义 `CoreSlots` Pydantic 模型，明确包含 `age`, `temperature`, `symptoms` (List), `duration`。
    - 重写 `merge_entities` 方法：
        - 实现**增量更新**逻辑：仅当新值非空且有效时更新。
        - 对 `symptoms` 列表执行去重合并。
        - 增加 `has_required_slots()` 方法，用于快速判断是否满足 `READY` 状态。

### 1.2 升级 `ChatPipeline` (业务编排)
**目标**：实现主动分诊 (Proactive Triage) 和结构化输出。
- **文件**：`backend/app/services/chat_pipeline.py`
- **任务**：
    - **Step 9 (计算缺失槽位)**：
        - 调用 `MedicalContext.has_required_slots()`。
        - 如果缺失，进入 `COLLECTING_SLOTS` 状态。
        - **跳过机制**：确保不返回已存在的槽位。
    - **Step 10 (执行 Action - `_ask_missing_slots`)**：
        - 根据缺失的槽位（如 `duration`），生成 `suggested_options`（例如 `["1天", "2天", "3天"]`）。
        - 将 `suggested_options` 和 `slot_type` 注入到 `PipelineResult` 的 `metadata` 中。
    - **分诊稳定性**：
        - 在 `process_message` 中，强制检查：若状态不是 `READY` 或 `TRIAGE_COMPLETE`，且意图为 `consult`，则强制转为 `SLOT_FILLING` 流程，**屏蔽 RAG 调用**。

### 1.3 优化 LLM 实体提取
**目标**：解决"首句实体未存下"的问题。
- **文件**：`backend/app/services/llm_service.py` (需检查)
- **任务**：
    - 优化 System Prompt，强调“一次性提取所有出现的实体”，特别是 `age` 和 `temperature`。

## 2. 前端重构：交互体验升级 (JavaScript)

### 2.1 重构 `app.js` 渲染逻辑
**目标**：修复 UI 缺陷，支持多选和位置控制。
- **文件**：`frontend/app.js`
- **任务**：
    - **提取 `handleSlotFilling` 函数**：从庞大的 `sendMessageStream` 中剥离追问卡片渲染逻辑。
    - **位置控制**：确保所有新生成的 DOM 元素（包括追问卡片）都使用 `chat.appendChild` 并紧跟在 Assistant 消息之后。
    - **容错处理**：
        - 优先读取后端返回的 `metadata.suggested_options`。
        - 如果后端未返回，回退到前端 `QUICK_REPLIES_MAP`。
        - 如果都为空，不渲染 Chips，仅显示文本提示，避免显示 "0"。

### 2.2 实现“多选+确认”交互
**目标**：防止误触，提高输入准确性。
- **文件**：`frontend/app.js`, `frontend/styles.css`
- **任务**：
    - **多选支持**：
        - 为 `symptoms` 等列表型槽位启用多选模式。
        - 点击 Chip 切换 `selected` 样式（需新增 CSS 类）。
    - **确认机制**：
        - 新增【确认/选好了】按钮。
        - 点击后，将所有选中 Chip 的值合并为字符串（如“发烧、咳嗽”）发送给后端。

## 3. 验证计划

1.  **实体提取测试**：输入“宝宝8个月，发烧38.5度”，检查后端日志是否正确提取 `age=8个月`, `temperature=38.5`, `symptom=发烧`。
2.  **追问逻辑测试**：系统应仅追问 `duration`（持续时间），且 UI 显示对应的 Chips。
3.  **多选交互测试**：在追问症状时，选择“咳嗽”和“流鼻涕”，点击确认，检查发送的消息是否为合并文本。
4.  **RAG 屏蔽测试**：在信息未全时询问“怎么办”，系统应继续追问槽位而非直接给出 RAG 建议。
